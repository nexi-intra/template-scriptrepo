# Environment Management Scripts

This repository contains two PowerShell scripts designed to manage and validate environment variables efficiently:

- **`build-env.ps1`**: Aggregates environment variables from multiple `.env` files into a single PowerShell script.
- **`check-env.ps1`**: Validates the presence and completeness of required environment variables before executing critical operations.

## Table of Contents

- [build-env.ps1](#build-envps1)
  - [Description](#description)
  - [Parameters](#parameters)
  - [Functionality](#functionality)
  - [Usage Example](#usage-example)
- [check-env.ps1](#check-envps1)
  - [Description](#description-1)
  - [Parameters](#parameters-1)
  - [Functionality](#functionality-1)
  - [Usage Example](#usage-example-1)

---

## build-env.ps1

### Description

`build-env.ps1` is a PowerShell script that automates the aggregation of environment variables from multiple `.env` files located in the current directory and its parent directories. It consolidates these variables into a single PowerShell script (`temp.ps1` by default) that can be sourced to set the environment variables in the current session.

### Parameters

- `-OutputFile` (optional)
  - **Type:** `string`
  - **Default:** `"temp.ps1"`
  - **Description:** Specifies the name of the output PowerShell script that will contain the aggregated environment variable settings.

### Functionality

1. **Initialization:**

   - Checks if the specified output file exists. If it does, the script removes it to ensure a fresh start.
   - Writes initial header comments to the output file indicating that it was generated by `koksmat`.

2. **Environment File Discovery:**

   - Searches for all `.env` files starting from the current directory and moving upwards through parent directories.
   - Collects the full paths of all found `.env` files and sorts them by their path length (closest directories first).

3. **Environment Variable Extraction:**

   - For each discovered `.env` file:
     - Appends header comments with the file path to the output script.
     - Reads each line of the `.env` file, ignoring empty lines and comments.
     - Parses lines in the `KEY=VALUE` format.
     - Writes each environment variable assignment to the output script in the format `$env:KEY = "VALUE"`.
     - Ensures that values are properly quoted to handle spaces and special characters.

4. **Finalization:**
   - Appends additional settings to the output script, such as setting the `WORKDIR` environment variable.
   - Outputs a confirmation message indicating that environment variables have been successfully extracted and written to the specified output file.

### Usage Example

To generate a PowerShell script named `setup-env.ps1` that sets all environment variables:

```powershell
.\build-env.ps1 -OutputFile "setup-env.ps1"
```

This command will create `setup-env.ps1` containing all the environment variable assignments extracted from `.env` files. To apply these variables in your current session, execute:

```powershell
.\setup-env.ps1
```

---

## check-env.ps1

### Description

`check-env.ps1` is a PowerShell script that verifies the existence and completeness of essential environment variables required for your application or scripts to run correctly. It ensures that all necessary configurations are present before proceeding with critical operations, thereby preventing runtime errors due to missing or improperly set environment variables.

### Parameters

- `$requiredVars` (optional)
  - **Type:** `array of strings`
  - **Default:**
    ```powershell
    @(
      'DEVICEKPIBLOB',
      'GRAPH_APPID',
      'GRAPH_APPSECRET',
      'GRAPH_APPDOMAIN',
      'GRAPH_ACCESSTOKEN',
      'POSTGRES_SERVER'
    )
    ```
  - **Description:** Specifies the list of environment variable names that are required. You can provide a custom list if needed.

### Functionality

1. **Environment Variable Enumeration:**

   - Retrieves all current environment variables and stores them in a hashtable (`$envHash`) for efficient lookup.

2. **Validation:**

   - Iterates through each variable listed in `$requiredVars`.
   - Checks if each required environment variable exists and is not empty.
   - Collects any missing or empty variables into the `$missingVars` array.

3. **Reporting:**
   - If there are missing or empty required variables:
     - Outputs a list of these variables to the console.
     - Throws an error and exits the script with a non-zero status code to indicate failure.
   - If all required variables are present and properly set:
     - Outputs a confirmation message stating that all required environment variables are present.

### Usage Example

To validate the default set of required environment variables:

```powershell
.\check-env.ps1
```

**Custom Validation:**

If you need to validate a different set of environment variables, pass a custom array to the `-requiredVars` parameter:

```powershell
.\check-env.ps1 -requiredVars @('VAR1', 'VAR2', 'VAR3')
```

**Expected Output:**

- **All Variables Present:**

  ```
  All required environment variables are present.
  ```

- **Missing or Empty Variables:**
  ```
  The following required environment variables are missing or empty:
  - GRAPH_APPSECRET
  - POSTGRES_SERVER
  ```

---

## Summary

These scripts are essential for managing and validating environment configurations in your PowerShell projects. `build-env.ps1` simplifies the process of setting up environment variables from multiple sources, while `check-env.ps1` ensures that all necessary configurations are in place before your application runs.

---

**Note:** Always handle sensitive information such as secrets and tokens securely. Avoid exposing them in source control or logs.
